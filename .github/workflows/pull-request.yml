name: Lint and Unit Test

on:
  pull_request:
  
defaults:
  run:
    shell: bash

env:
  CT_CHART_DIRS: "."

jobs:
  lint-and-unittest:
    name: Lint Chart and Run Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0   # ct needs full history to detect changed charts

      - name: Merge with target branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
          git merge --no-ff FETCH_HEAD
          ls -la

      - name: Install helm-unittest plugin
        run: |
          helm plugin install https://github.com/helm-unittest/helm-unittest --version v1.0.0
          helm plugin list

      - name: helm-unittest (all changed charts)
        run: |
          helm unittest ignition

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2

      - name: ct lint
        run: |
          ct lint --all
